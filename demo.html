<html>

<head>
	<title>POI-Client Demo</title>

	<link rel="stylesheet" type="text/css" media="all" href="styles.css"/>

	<script type="text/javascript" src="js/xml3d-4.8-custom.js"></script>
	<script type="text/javascript" src="js/camera.js"></script>
    <script type="text/javascript" src="js/3d-map-tiles.js"></script>
    <script type="text/javascript" src="js/rvi-asset-operators.js"></script>
    <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
	
	<script type="text/javascript">
		
		var poi_uri = 'api/poi/bd5a001c-5cd9-4817-a338-8fd5bf55623e';
		var poi_components = ['fw_core', 'fw_xml3d', 'fw_rvi'];
		
		var poi_data = {};
		var poi_elem = {};
		
		var poi_group = null;
		
		function json_path(data, path, default_value)
		{
			var obj = data;
			var parts = path.split('.');
			//console.log(obj);
			//console.log(parts);

			while (parts.length > 0)
			{
				var prop = parts.shift();
				obj = obj[prop];
				if (typeof(obj) === 'undefined')
					return default_value;
			}
			return obj;
		}

		function update_poi(elem, data)
		{
			var xml3d_config_map = json_path(data, 'fw_xml3d.config.map');
			if (typeof(xml3d_config_map) === 'undefined')
				return;

			var ad = elem.find("assetdata");
			//console.log(ad);

			for (var attr_name in xml3d_config_map) {
				var attr_path = xml3d_config_map[attr_name];
				var attr_value = json_path(data, attr_path, 0);
				
				var at = ad.children("float[name='"+attr_name+"']");
				if (at.length == 0) {
					at = $("<float>").attr("name", attr_name);
					ad.append(at);
				}
				console.log(attr_name);
				console.log(attr_value);

				at.text(attr_value);
			}
		}
		
		function add_poi(data)
		{
			var xml3d_asset = json_path(data, 'fw_xml3d.asset');
			
			var m = $("<model>")
				.attr("src", xml3d_asset);

			var ad = $("<assetdata>")
				.attr("name", "config");
			m.append(ad);
			
			poi_group.append(m);
			return m;
		}
		
		function resolve_poi_references(data)
		{
			for (var comp_name in data) {
				if (!comp_name in poi_components)
					continue;
					
				var comp_data = data[comp_name];
				if (typeof(comp_data) !== 'object') {
					// TODO: validate uri
					var comp_uri = comp_data;
					console.log('Lazy load ' + comp_uri);
					$.getJSON(comp_uri).done(function(ref_data) {
						var comp_data = ref_data[comp_name];
						if (comp_data === 'undefined') return;
						data[comp_name] = comp_data;
					});
				}
			}
		}

		function load_poi(uri)
		{
			var req = $.getJSON(uri);
		
			req.done(function( data ) {
				//console.log(data);
				resolve_poi_references(data);
				node = add_poi(data);
				poi_data[uri] = data;
				poi_elem[uri] = node;
				//console.log(node);
			});
		}
		
		function update_poi_data()
		{
			console.log("update poi data ...");
			for (var uri in poi_data) {
				var elem = poi_elem[uri];
				var data = poi_data[uri];
				var rvi_uri = json_path(data, 'fw_rvi.source.self');
				
				$.getJSON(rvi_uri).done(function(ref_data) {
					data['fw_rvi'] = ref_data['fw_rvi'];
					poi_data[uri] = data;
					update_poi(elem, data);
				});
			}
		};
		
		function onload()
		{
			poi_group = $("group#pois");

			console.log("Load POI.");
			load_poi(poi_uri);
			
			window.setInterval(update_poi_data, 500);
		}
		
		window.addEventListener('load', onload);
		
	</script>
</head>

<body>
	<div id="myxml3d">
		<xml3d id="myxml3dcanvas" activeView="#defaultView" style="width: 100%; height: 100%; background-color:0xeeeeee;" >

			<!-- Asset Instance -->
			<transform id="ground_tf_scale" scale="20 0.1 20"></transform>
			<transform id="center_tile_tf" translation="-0.5 0 -0.5"></transform>
			
			<group id="ground" transform="#ground_tf_scale">
				<group transform="#center_tile_tf">
					<!-- <model src="api/3d-tiles/42362-asset.xml#plane"></model> -->
					<!-- <model src="api/3d-tiles/42362-asset.xml#buildings"></model> -->
				</group>
			</group>
			
			<transform id="poi_tf" scale="0.3 0.3 0.3"></transform>
			<group id="pois" transform="#poi_tf"></group>
			
			<!-- Light and View -->
			<view id="defaultView" position="9.318857192993164 11.63010311126709 20.072357177734375" orientation="-0.772652268409729 0.6338370442390442 0.03548542410135269 0.6390923836193999"></view>
			
			<lightshader id="light1" script="urn:xml3d:lightshader:directional">
				<float3 name="intensity">0.9 0.9 0.9</float3>
			</lightshader>
			
			<group style="transform: rotateX(-60deg)" >
				<light shader="#light1"></light>
			</group>

		</xml3d>
		<div id="logo"><img src="img/xml3dlogo.png"/></div>
		<div id="attribution" class="attribution">
			Data &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors
		</div>
	</div>
</body>

</html>
